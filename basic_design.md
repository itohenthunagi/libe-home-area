# 1. 概要

## 1.1 システム目的

ユーザーが「都道府県」と「市区町村」を選択/入力すると、対象エリアにおける **提供サービス（プロバイダー種別 × カテゴリ）ごとの対応状況**（例：○ / 要相談 / 空欄など）を一覧表示する。

## 1.2 背景・解決したい課題

Google Apps Script（GAS）のWebアプリをそのまま公開すると、画面上部に「Google Apps Scriptのユーザーが作成〜」等のバナーが表示され、利用者が不安に感じる可能性がある。
そのため、**GASのWebアプリは使わず**、ユーザーが `script.google.com` を開かない構成（静的Web + CSV参照）に移行する。

## 1.3 方式（採用アーキテクチャ）

* **フロントエンド**：静的HTML/JS/CSS（GitHub Pagesでホスト）
* **バックエンド**：なし（GAS不要）
* **データソース**：Googleスプレッドシートを「ウェブに公開（CSV）」したURLから取得
* **データ公開方針**：同一スプレッドシート内に「公開用シート」を作成し、そのシートだけを公開対象とする
  （非公開データが含まれる他シートは公開しない）

---

# 2. 用語定義

* **都道府県（pref）**：データ列A
* **市区町村（muni）**：データ列B
* **ふりがな（kana）**：データ列C（サジェスト用）
* **判定セル（judge）**：データ列D以降（提供サービスの対応状況）
* **プロバイダー種別（provider_type）**：ヘッダ行「2行目」のD列以降
* **カテゴリ（category）**：ヘッダ行「3行目」のD列以降
* **公開用シート**：Web公開してよい情報のみを含むシート（例：`公開_まとめ`）

---

# 3. 機能要件

## 3.1 画面（UI）要件

### 3.1.1 画面構成

* タイトル：対応エリア確認
* 入力欄：

  1. 都道府県：`<select>`（プルダウン）
  2. 市区町村：`<input type="text" list="muniList">`（datalistで候補表示）
* ボタン：確認する
* 結果表示エリア：

  * ヘッダ：選択した「都道府県 + 市区町村」
  * 一覧：提供サービス（provider × category）ごとの対応状況（value）をカード形式で列挙
* フッター：お問い合わせリンク（別URLに遷移）

### 3.1.2 デザイン（トンマナ）

* 現行HTML（GAS版）で採用していたフォント、サイズ、配色、余白、カードUIを踏襲すること
  * C:\Users\81905\Dropbox (個人用)\CursorProjects\libe_koumu_area\index.htmlを参照
* フォント：Noto Sans JP（Google Fonts）
* レスポンシブ対応（スマホ優先。PC幅では中央寄せ等）

> 注：仕様書では「現行HTMLの見た目を踏襲」と定義する。実装時は提供される現行HTML/CSSをそのまま移植し、ロジック部のみ置換する。

---

## 3.2 入力とサジェスト要件

### 3.2.1 都道府県プルダウン

* CSV読み込み後、データ行（4行目以降）の列Aから都道府県を抽出
* **重複除去**し、プルダウンの選択肢にする
* 空文字は除外
* 並び順：原則としてデータ出現順（必要なら昇順ソート可だが、現行踏襲なら出現順）

### 3.2.2 市区町村サジェスト（datalist）

* 都道府県が未選択の場合、候補は空
* 都道府県選択後：

  * 同じ都道府県の行に限定し、列B（市区町村）と列C（ふりがな）を候補リストにする
  * ユーザー入力（query）に対して部分一致で絞り込み

    * `muni.includes(query)` または `kana.includes(query)` のどちらかでヒット
  * ヒット数上限：30件（`SUGGEST_LIMIT`）
  * 市区町村名の重複は除外（同名を二重に出さない）

### 3.2.3 「候補から選ばれた」検証

* ユーザーが入力した市区町村（完全一致）が、当該都道府県の候補リストに存在しない場合はエラー
* エラーメッセージ：

  * 「市区町村は候補（プルダウン）から選択してください」
* 目的：手入力ミス（表記揺れ・タイプミス）による誤判定を防ぐ

---

## 3.3 判定取得（コアロジック）

### 3.3.1 該当行の特定

* 条件：列A（都道府県）と列B（市区町村）の **両方が完全一致**する行を探す
* ヒット件数の扱い：

  * 0件：エラー「該当する市区町村が見つかりませんでした」
  * 2件以上：エラー「同一の都道府県×市区町村が複数行に存在します（データ重複）」
  * 1件：OK（その行を判定行として使用）

### 3.3.2 ヘッダの読み取り

* 2行目（HEADER_PROVIDER_ROW=2）の D列以降：provider配列
* 3行目（HEADER_CATEGORY_ROW=3）の D列以降：category配列
* provider または category が空の場合、その列は結果から除外する（空ヘッダ列は無視）

### 3.3.3 判定セルの読み取り

* 該当行の D列以降を values配列として取得
* 結果 items を以下の構造で生成する：

```json
{
  "ok": true,
  "pref": "東京都",
  "muni": "新宿区",
  "items": [
    { "provider": "内装", "category": "大規模", "value": "○" },
    { "provider": "内装", "category": "小規模", "value": "" },
    ...
  ]
}
```

---

## 3.4 表示ロジック

### 3.4.1 カテゴリ名の表示変換（現行踏襲）

* 表示時にカテゴリ名を変換するマップを持つ（例）：

  * 「大規模」→「大規模リフォーム」
  * 「小規模」→「小規模リフォーム」
* 変換対象以外はそのまま表示

### 3.4.2 ステータス表示（バッジ等）

value 文字列から表示クラスを決める（例）：

* 空欄/未定義/「—」：`unavailable`（表示文言：対応エリア外）
* value に「要相談」を含む：`consult`
* value に「一部」または「除く」を含む：`partial`
* value が「○」または「対応」を含む：`available`
* その他：`unavailable`

※上記は現行HTMLの挙動を踏襲。必要なら運用に合わせて調整可能だが、本仕様ではこのルールを採用とする。

---

## 3.5 エラー・例外仕様

### 3.5.1 入力エラー

* 都道府県未選択：
  「都道府県を選択してください」
* 市区町村未入力：
  「市区町村を入力してください」
* 候補未選択（検証NG）：
  「市区町村は候補（プルダウン）から選択してください」

### 3.5.2 データエラー

* 該当行0件：
  「該当する市区町村が見つかりませんでした」
* 該当行重複：
  「同一の都道府県×市区町村が複数行に存在します（データ重複）」
* CSV取得/解析失敗：
  「データの読み込みに失敗しました（CSV公開URLを確認してください）」

### 3.5.3 動作中表示

* 「確認する」押下後、判定中は「検索中…」表示を出す（UI演出）
* 判定が完了したら結果表示に置き換える

---

# 4. データ要件（スプレッドシート）

## 4.1 スプレッドシート構成（同一ファイル内）

* 非公開シート（例）：`まとめ`

  * 社内用データ、公開したくない列・情報が含まれていてよい
* 公開用シート（例）：`公開_まとめ`

  * Webに公開してもよい情報のみを含む
  * このシートのみ「ウェブに公開（CSV）」する

## 4.2 公開用シートの作り方（ノーコード）

最小構成は「必要列だけ転記」する。

### 4.2.1 丸ごと転記（簡単だが危険）

`公開_まとめ!A1` に：

* `=ARRAYFORMULA(まとめ!A:ZZ)` など

※非公開情報まで含まれる可能性があるため推奨しない。

### 4.2.2 必要列のみ転記（推奨）

`公開_まとめ` では必要列だけを参照する。
（例：A〜CとD以降判定列が必要。不要な機微情報列があるなら除外する）

* 具体例（列を絞る方法）：

  * 元シートの必要範囲が連続なら：`=ARRAYFORMULA(まとめ!A:V)` のように最終列を絞る
  * 不連続なら：`={まとめ!A:C, まとめ!D:V}` のように結合（※必要に応じて）

> 本仕様では「公開用シートには公開してよい情報のみが存在すること」をデータ要件として強制する。

## 4.3 行・列仕様（公開_まとめ）

* 1行目：任意（未使用でもよい）
* 2行目：D列以降に provider_type（表示用文字列）
* 3行目：D列以降に category（表示用文字列）
* 4行目以降：データ

  * A列：都道府県（pref）
  * B列：市区町村（muni）
  * C列：ふりがな（kana）
  * D列以降：判定文字列（value）

---

# 5. 非機能要件

## 5.1 セキュリティ/公開範囲

* 公開CSVのURLを知っている人はデータを取得できるため、公開用シートには機微情報を含めないこと
* 利用者の入力（都道府県/市区町村）はサーバに送信しない（ただしCSV取得は行う）
* フロントは静的ホスティング（GitHub Pages）

## 5.2 パフォーマンス

* 初回ロード時にCSVを1回取得し、以後はブラウザメモリ内データで検索・判定する
* 候補サジェストは debounce（例：200ms）を入れ、タイピングのたびに重い処理を連打しない
* CSVが大きくなりすぎる場合は性能課題が出る可能性（目安は実データ次第）。必要なら事前に都道府県別に分割などを検討する

## 5.3 更新反映

* スプレッドシートの「ウェブに公開（CSV）」は反映に遅延が出る可能性がある（数分単位でズレる場合がある）
* それでも運用上問題ない前提とする
  （もし即時反映必須なら、本方式は不適。別途バックエンド/非公開API方式に切り替える）

---

# 6. 実装仕様（フロントエンド）

## 6.1 技術スタック

* HTML/CSS/JavaScript（Vanilla）
* CSVパース：PapaParse（CDN利用）
* フォント：Google Fonts（Noto Sans JP）

## 6.2 設定値（コード内コンフィグ）

最低限、以下を定数として持つ：

* `CSV_URL`：公開CSVのURL
* `CONTACT_URL`：お問い合わせURL
* `HEADER_PROVIDER_ROW=2`
* `HEADER_CATEGORY_ROW=3`
* `DATA_START_ROW=4`
* `FIRST_JUDGE_COL=4`（D列）
* `SUGGEST_LIMIT=30`

## 6.3 CSV取得と解析

* ページロード時にCSVを取得して2次元配列 `table` に変換
* `table` を以下に分解してインデックスを構築：

  * `providers[]`：2行目D列以降
  * `categories[]`：3行目D列以降
  * `rows[]`：4行目以降の全行
  * `rowsByPref: Map<pref, Array<{muni, kana, row}>>`：都道府県単位の検索高速化用

## 6.4 主要関数（擬似仕様）

* `buildIndexFromTable(table) -> {providers,categories,rowsByPref}`
* `getPrefList(rowsByPref) -> string[]`
* `suggestMunicipalities(pref, query) -> Array<{muni,kana}>`
* `validateMunicipality(pref, muni) -> {ok:boolean, message?:string}`
* `getMenu(pref, muni) -> {ok:boolean, items?:..., message?:string}`

---

# 7. デプロイ仕様（GitHub Pages）

## 7.1 リポジトリ構成（最小）

* `/index.html`（CSS/JSを内包してもよい）
* （任意）`/assets/...`（画像等）

## 7.2 GitHub Pages設定

* Settings → Pages
* Source：Deploy from a branch
* Branch：main / root
* 公開URLが発行される

---

# 8. 既知の制約と代替案

## 8.1 制約：CSV取得が環境により失敗する可能性

ブラウザから `googleusercontent` 系の公開CSVを直接fetchすると、環境やタイミングにより取得が失敗するケースがあり得る。
（この場合は「データ読み込み失敗」になる）

## 8.2 代替案A（堅牢）：CSVをリポジトリに同梱する

* 公開CSVを手動ダウンロードして `data.csv` としてGitHub repoに置く
* `CSV_URL` を `./data.csv` にする
* 同一オリジンのため安定性が高い

## 8.3 代替案B（半自動）：GitHub ActionsでCSVを同期

* 定期実行で公開CSVを取得し、repo内の `data.csv` を更新
* 無料枠内で運用可能なことが多い（ただしGitHubの制限・利用状況による）

※本仕様の実装スコープはまず「公開CSV直読み」。上記代替案は必要に応じて拡張とする。

---

# 9. 受け入れ基準（Acceptance Criteria）

以下を満たしたら「完成」とする：

1. GitHub PagesのURLを開いて、GAS由来の上部バナー等が表示されない
2. 都道府県プルダウンがCSVのA列から生成される（重複なし）
3. 都道府県選択後、市区町村入力で候補が表示される（muni/kanaの部分一致、最大30件）
4. 候補にない市区町村を入力して確認するとエラーが出る
5. 候補から選んで確認すると、該当行のD列以降が provider×category の形式で一覧表示される
6. データ重複（同じpref×muniが複数行）時に明確なエラーが出る
7. お問い合わせリンクが指定URLに遷移する
8. デザインが現行HTMLのトンマナ（フォント/サイズ/カードUI）を踏襲している

---

# 10. 実装者向けメモ（重要）

* **公開用シートに「公開してよい情報しか入れない」**が最重要。ここを守れないと方式が破綻する
* 更新反映の遅延が許容できない場合は、将来的に「非公開API（バックエンド）」方式へ切替が必要
* 現行HTMLの見た目を維持するため、CSS/DOM構造は極力そのままにし、`google.script.run` 依存だけ除去する